<?xml version="1.0" encoding="utf-8"?>
<!--
  OneStream XF Data Management - Connection Definition
  Connection: Network File Share for Data Exchange
  Purpose: File-based data integration for MES exports, budget templates, and data exchange
  Environment: Production
  Created: 2026-02-18

  IMPORTANT: The OneStream application service account must have appropriate
  NTFS and share-level permissions on the file server paths configured below.
-->
<OneStreamXF>
  <DataManagement>
    <Connection>

      <!-- ============================================================
           CONNECTION IDENTITY
           ============================================================ -->
      <ConnectionName>FileShare_DataExchange</ConnectionName>
      <ConnectionDescription>Network file share connection for file-based data exchange. Handles inbound data files (MES production exports, budget templates, manual journals) and outbound files (reports, reconciliation extracts, audit exports). Includes automated file lifecycle management with archival and error handling.</ConnectionDescription>
      <ConnectionType>FileSystem</ConnectionType>
      <IsActive>true</IsActive>
      <Category>FileIntegration</Category>
      <SourceSystem>FileShare</SourceSystem>

      <!-- ============================================================
           BASE PATH CONFIGURATION
           ============================================================ -->
      <FileSystemConfiguration>
        <!-- Root UNC path for all data exchange operations -->
        <BasePath>\\fileserver\OneStream\DataExchange\</BasePath>
        <!-- Alternate path for disaster recovery / failover -->
        <AlternateBasePath>\\fileserver-dr\OneStream\DataExchange\</AlternateBasePath>
        <!-- Use alternate path if primary is unavailable -->
        <AutoFailover>true</AutoFailover>

        <!-- ============================================================
             SUBFOLDER STRUCTURE
             Each subfolder serves a specific purpose in the data flow.
             ============================================================ -->
        <Subfolders>

          <!-- INBOUND: Landing zone for files to be processed -->
          <Subfolder name="Inbound">
            <Path>\\fileserver\OneStream\DataExchange\Inbound\</Path>
            <Description>Landing zone for inbound data files from source systems. Files are deposited here by upstream processes (MES, budget owners, etc.) and picked up by OneStream Data Management sequences.</Description>
            <Access>ReadWrite</Access>
            <!-- Sub-directories by source type -->
            <SubDirectories>
              <Directory>MES</Directory>
              <Directory>Budget</Directory>
              <Directory>ManualJournal</Directory>
              <Directory>StatisticalData</Directory>
              <Directory>Allocations</Directory>
            </SubDirectories>
          </Subfolder>

          <!-- OUTBOUND: Files generated by OneStream for downstream consumption -->
          <Subfolder name="Outbound">
            <Path>\\fileserver\OneStream\DataExchange\Outbound\</Path>
            <Description>Output directory for files generated by OneStream (reports, reconciliation extracts, data feeds to other systems).</Description>
            <Access>ReadWrite</Access>
            <SubDirectories>
              <Directory>Reports</Directory>
              <Directory>Reconciliation</Directory>
              <Directory>AuditExtracts</Directory>
              <Directory>Downstream</Directory>
            </SubDirectories>
          </Subfolder>

          <!-- ARCHIVE: Successfully processed files moved here -->
          <Subfolder name="Archive">
            <Path>\\fileserver\OneStream\DataExchange\Archive\</Path>
            <Description>Archive directory for successfully processed inbound files. Files are moved here after successful load with timestamp suffix for traceability.</Description>
            <Access>ReadWrite</Access>
            <!-- Archive retention: files older than this are eligible for cleanup -->
            <RetentionDays>90</RetentionDays>
            <!-- Archive folder structure: Archive/YYYY/MM/ -->
            <SubfolderPattern>{Year}/{Month}/</SubfolderPattern>
          </Subfolder>

          <!-- ERROR: Files that failed processing are moved here -->
          <Subfolder name="Error">
            <Path>\\fileserver\OneStream\DataExchange\Error\</Path>
            <Description>Error directory for files that failed validation or processing. Each file is accompanied by an error log file (.err) describing the failure reason.</Description>
            <Access>ReadWrite</Access>
            <RetentionDays>30</RetentionDays>
            <!-- Generate companion error log for each failed file -->
            <GenerateErrorLog>true</GenerateErrorLog>
            <ErrorLogExtension>.err</ErrorLogExtension>
          </Subfolder>

        </Subfolders>
      </FileSystemConfiguration>

      <!-- ============================================================
           FILE PATTERNS AND FORMAT DEFINITIONS
           ============================================================ -->
      <FilePatterns>

        <!-- CSV files from MES and other flat-file sources -->
        <Pattern name="CSV">
          <FileExtension>*.csv</FileExtension>
          <Delimiter>,</Delimiter>
          <TextQualifier>"</TextQualifier>
          <HeaderRow>true</HeaderRow>
          <Encoding>UTF-8</Encoding>
          <LineTerminator>CRLF</LineTerminator>
          <DateFormat>yyyy-MM-dd</DateFormat>
          <DecimalSeparator>.</DecimalSeparator>
          <ThousandsSeparator></ThousandsSeparator>
          <!-- Maximum file size in MB before warning -->
          <MaxFileSizeMB>500</MaxFileSizeMB>
        </Pattern>

        <!-- Excel files for budget templates and manual entries -->
        <Pattern name="Excel">
          <FileExtension>*.xlsx</FileExtension>
          <HeaderRow>true</HeaderRow>
          <DateFormat>yyyy-MM-dd</DateFormat>
          <MaxFileSizeMB>100</MaxFileSizeMB>
          <!-- Excel-specific settings -->
          <ExcelSettings>
            <ReadNamedRanges>true</ReadNamedRanges>
            <TreatEmptyRowAsEndOfData>true</TreatEmptyRowAsEndOfData>
            <ImportFormulasAsValues>true</ImportFormulasAsValues>
            <!-- Supported Excel format versions -->
            <SupportedFormats>
              <Format>.xlsx</Format>
              <Format>.xlsm</Format>
            </SupportedFormats>
          </ExcelSettings>
        </Pattern>

        <!-- Tab-delimited text files -->
        <Pattern name="TabDelimited">
          <FileExtension>*.txt</FileExtension>
          <Delimiter>	</Delimiter>
          <TextQualifier>"</TextQualifier>
          <HeaderRow>true</HeaderRow>
          <Encoding>UTF-8</Encoding>
          <MaxFileSizeMB>500</MaxFileSizeMB>
        </Pattern>

        <!-- XML data files -->
        <Pattern name="XML">
          <FileExtension>*.xml</FileExtension>
          <Encoding>UTF-8</Encoding>
          <MaxFileSizeMB>200</MaxFileSizeMB>
          <SchemaValidation>true</SchemaValidation>
        </Pattern>

      </FilePatterns>

      <!-- ============================================================
           AUTHENTICATION
           File share uses Windows integrated authentication via
           the OneStream application service account.
           ============================================================ -->
      <Authentication>
        <AuthenticationType>WindowsIntegrated</AuthenticationType>
        <!-- OneStream app pool identity requires:
             - Read/Write/Modify on all subfolders
             - List folder contents
             - Create files/folders
             - Delete (for archive/cleanup operations)
        -->
        <ServiceAccountNote>The OneStream IIS Application Pool identity (SVC_ONESTREAM_APP) must have NTFS Read/Write/Modify permissions on all configured paths, plus share-level Change permission.</ServiceAccountNote>

        <!-- Optional: explicit credentials if not using integrated auth -->
        <ExplicitCredentials>
          <CredentialVaultKey>VAULT_FILESHARE_SVC</CredentialVaultKey>
          <Domain>CORP</Domain>
          <Username>SVC_ONESTREAM_FILE</Username>
          <Password>%%CREDENTIAL_VAULT%%</Password>
        </ExplicitCredentials>
      </Authentication>

      <!-- ============================================================
           FILE LIFECYCLE MANAGEMENT
           ============================================================ -->
      <FileLifecycle>
        <!-- After successful processing -->
        <OnSuccess>
          <Action>MoveToArchive</Action>
          <!-- Append timestamp to filename: originalname_20260218_143000.csv -->
          <AppendTimestamp>true</AppendTimestamp>
          <TimestampFormat>yyyyMMdd_HHmmss</TimestampFormat>
        </OnSuccess>

        <!-- After failed processing -->
        <OnError>
          <Action>MoveToError</Action>
          <AppendTimestamp>true</AppendTimestamp>
          <GenerateErrorReport>true</GenerateErrorReport>
          <SendNotification>true</SendNotification>
        </OnError>

        <!-- File locking: ensure exclusive access during processing -->
        <FileLocking>
          <LockDuringProcessing>true</LockDuringProcessing>
          <LockTimeoutSeconds>60</LockTimeoutSeconds>
          <RetryOnLock>true</RetryOnLock>
          <LockRetryAttempts>3</LockRetryAttempts>
          <LockRetryDelaySeconds>10</LockRetryDelaySeconds>
        </FileLocking>

        <!-- Archive cleanup schedule -->
        <ArchiveCleanup>
          <Enabled>true</Enabled>
          <CleanupSchedule>Weekly</CleanupSchedule>
          <CleanupDay>Sunday</CleanupDay>
          <CleanupTimeUTC>03:00</CleanupTimeUTC>
          <ArchiveRetentionDays>90</ArchiveRetentionDays>
          <ErrorRetentionDays>30</ErrorRetentionDays>
        </ArchiveCleanup>
      </FileLifecycle>

      <!-- ============================================================
           TIMEOUT AND PERFORMANCE
           ============================================================ -->
      <TimeoutSettings>
        <ConnectionTimeout>10</ConnectionTimeout>
        <FileReadTimeout>120</FileReadTimeout>
        <FileWriteTimeout>120</FileWriteTimeout>
        <!-- Batch processing: number of rows to read at once -->
        <BatchSize>10000</BatchSize>
      </TimeoutSettings>

      <!-- ============================================================
           TEST / HEALTH CHECK
           ============================================================ -->
      <TestQuery>
        <!-- Validate connectivity by checking folder existence and access -->
        <TestType>FolderAccess</TestType>
        <TestPaths>
          <Path access="Read">\\fileserver\OneStream\DataExchange\Inbound\</Path>
          <Path access="Write">\\fileserver\OneStream\DataExchange\Outbound\</Path>
          <Path access="Write">\\fileserver\OneStream\DataExchange\Archive\</Path>
          <Path access="Write">\\fileserver\OneStream\DataExchange\Error\</Path>
        </TestPaths>
        <WriteTestFile>true</WriteTestFile>
        <TestFileName>_onestream_connectivity_test.tmp</TestFileName>
        <CleanupTestFile>true</CleanupTestFile>
        <TimeoutSeconds>10</TimeoutSeconds>
      </TestQuery>

      <!-- ============================================================
           LOGGING AND AUDIT
           ============================================================ -->
      <Logging>
        <LogLevel>Info</LogLevel>
        <LogConnectionEvents>true</LogConnectionEvents>
        <LogFileOperations>true</LogFileOperations>
        <LogFileContents>false</LogFileContents>
        <LogFileSizeAndRowCount>true</LogFileSizeAndRowCount>
        <MaskSensitiveData>true</MaskSensitiveData>
      </Logging>

    </Connection>
  </DataManagement>
</OneStreamXF>
